name: CI
on: [push]

# TODO(teddywilson) This is not very efficient because it installs these dependencies every time
# Should probably move to outsourced actions.
jobs:
  markdown-validation-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: teddywilson/shisito-markdown-validation@v1.1.10
  deploy:
    runs-on: ubuntu-latest
    needs: markdown-validation-tests
    if: github.ref == 'refs/heads/master'
    steps:
    - uses: actions/checkout@v2
    - name: Read .nvmrc
      run: echo ::set-output name=NVMRC::$(cat .nvmrc)
      id: nvm
    - name: Use Node.js ${{ steps.nvm.outputs.NVMRC }}
      uses: actions/setup-node@v1
      with:
        node-version: "${{ steps.nvm.outputs.NVMRC }}"
    - name: Install Gatsby CLI
      run: sudo npm install -g gatsby-cli
      id: install-gatsby
    - name: Run deployment script
      run: sudo sh deploy.sh
      id: deployment-script
